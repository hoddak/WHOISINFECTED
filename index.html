<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ELISA 결과 제출 (QR 스캔)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    .row { margin-bottom: 12px; }
    #reader { width: 360px; max-width: 100%; margin: 8px 0; }
    #status { margin-top: 8px; font-size: 14px; color: #444; }
    button { padding: 8px 12px; font-size: 16px; margin-right: 8px; }
    select, input { padding: 8px; font-size: 16px; }
    .hint { font-size: 12px; color: #6b7280; }
  </style>
  <!-- html5-qrcode (QR 전용) -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <h2>ELISA 결과 제출</h2>

  <div class="row">
    <button id="startBtn">스캔 시작</button>
    <button id="stopBtn" disabled>중지</button>
    <span class="hint">모바일 브라우저 정책상 버튼 클릭 후 카메라가 시작됩니다.</span>
  </div>

  <div id="reader"></div>

  <div class="row">스캔된 Sample ID: <span id="sampleId">(없음)</span></div>

  <form id="resultForm" class="row">
    <label>
      결과 선택:
      <select id="result" required>
        <option value="">--선택--</option>
        <option value="Positive">Positive</option>
        <option value="Negative">Negative</option>
        <option value="Inconclusive">Inconclusive</option>
      </select>
    </label>
    <div class="row">
      <button type="submit">제출</button>
    </div>
  </form>

  <div id="status"></div>

  <script>
    // IMPORTANT: html5-qrcode는 QR만 지원합니다. Data Matrix까지 필요하면 ZXing 계열로 교체해야 합니다.

    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const readerEl = document.getElementById('reader');
    const sampleSpan = document.getElementById('sampleId');
    const statusEl = document.getElementById('status');

    let html5QrCode = null;
    let isRunning = false;
    let currentSampleId = '';

    function setRunning(running){
      isRunning = running;
      startBtn.disabled = running;
      stopBtn.disabled  = !running;
    }

    async function startScan(){
      statusEl.textContent = '';
      if (!html5QrCode) html5QrCode = new Html5Qrcode('reader');
      try {
        await html5QrCode.start(
          { facingMode: 'environment' },
          { fps: 10, qrbox: 250 },
          (decodedText, decodedResult) => {
            currentSampleId = decodedText;
            sampleSpan.textContent = currentSampleId;
            // 스캔 성공 시 즉시 멈추고 싶다면 다음 줄 주석 해제
            // stopScan();
          },
          (errMsg) => {
            // 프레임별 오류는 무시 (필요시 statusEl에 표시)
          }
        );
        setRunning(true);
      } catch (e) {
        alert('스캔 시작 실패: ' + e.message);
        setRunning(false);
      }
    }

    async function stopScan(){
      if (html5QrCode && isRunning){
        try { await html5QrCode.stop(); } catch {}
      }
      setRunning(false);
    }

    startBtn.addEventListener('click', startScan);
    stopBtn.addEventListener('click', stopScan);

    // 제출 → Google Apps Script (익명)
    document.getElementById('resultForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const result = document.getElementById('result').value;
      if (!currentSampleId){
        alert('Sample ID가 스캔되지 않았습니다.');
        return;
      }
      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbziU3VIgI8CvAfJYzPGBvnMhoIrOFqyEeZBHve7xWUqOiJoLVA0jSBC7FDQI-mbrKiR/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sampleId: currentSampleId, result })
        });
        const data = await res.json();
        if (data.status === 'success'){
          statusEl.textContent = '제출 완료!';
        } else {
          statusEl.textContent = '제출 실패(응답 에러)';
        }
      } catch(err){
        console.error(err);
        alert('제출 실패: ' + err.message);
      }
    });

    // HTTPS 강제 안내 (http로 접속 시 카메라 차단됨)
    if (location.protocol !== 'https:' && location.hostname !== 'localhost'){
      statusEl.textContent = '안내: HTTPS가 아니면 카메라가 동작하지 않습니다. 주소창이 https:// 로 시작하는지 확인하세요.';
    }
  </script>
</body>
</html>
