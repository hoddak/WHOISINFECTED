<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ELISA 결과 제출</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #preview { width: 100%; max-width: 420px; height: 300px; background: #000; border: 1px solid #ccc; margin-bottom: 10px; object-fit: contain; }
    input, select, button { margin: 5px 0; padding: 8px; font-size: 16px; }
    .hint { font-size: 12px; color: #6b7280; }
  </style>
</head>
<body>
  <h2>ELISA 결과 제출</h2>

  <!-- 스캔 제어 -->
  <div>
    <button id="startBtn">스캔 시작</button>
    <button id="stopBtn" disabled>중지</button>
    <span class="hint">iOS/Android에서 권한 정책상 버튼 클릭 후 시작하는 게 정상</span>
  </div>

  <!-- QR 코드 스캔 -->
  <video id="preview" playsinline muted></video>
  <div>스캔된 Sample ID: <span id="sampleId"></span></div>

  <!-- 결과 입력 -->
  <form id="resultForm">
    <label>결과 선택:
      <select id="result" required>
        <option value="">--선택--</option>
        <option value="Positive">Positive</option>
        <option value="Negative">Negative</option>
      </select>
    </label>
    <br />
    <button type="submit">제출</button>
  </form>

  <div id="status"></div>

  <!-- Instascan (QR 스캐너 라이브러리) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/instascan/1.0.0/instascan.min.js" defer></script>
  <script>
    // DOM 준비 후 실행
    document.addEventListener('DOMContentLoaded', () => {
      const videoEl = document.getElementById('preview');
      const startBtn = document.getElementById('startBtn');
      const stopBtn  = document.getElementById('stopBtn');
      const sampleSpan = document.getElementById('sampleId');
      const statusEl = document.getElementById('status');

      let currentSampleId = "";
      let scanner = null;
      let activeCameraId = null;

      function setRunning(running) {
        startBtn.disabled = running;
        stopBtn.disabled  = !running;
      }

      async function startScan() {
        statusEl.textContent = '';
        try {
          if (!window.Instascan) {
            alert('Instascan 로더 지연. 새로고침하세요.');
            return;
          }
          if (!scanner) {
            scanner = new Instascan.Scanner({ video: videoEl, mirror: false });
            scanner.addListener('scan', function (content) {
              currentSampleId = content;
              sampleSpan.textContent = currentSampleId;
            });
          }

          const cameras = await Instascan.Camera.getCameras();
          if (!cameras || cameras.length === 0) {
            alert('카메라를 찾을 수 없습니다.');
            return;
          }
          // 후면 카메라 우선: 대개 마지막이 후면
          const backCam = cameras.find(c => /back|rear|environment/i.test(c.name)) || cameras[cameras.length - 1];
          activeCameraId = backCam.id || backCam;

          // iOS 자동재생 정책 우회: playsinline + muted는 이미 video에 설정
          await scanner.start(backCam);
          setRunning(true);
        } catch (err) {
          console.error(err);
          alert('카메라 시작 실패: ' + err.message);
          setRunning(false);
        }
      }

      async function stopScan() {
        try {
          if (scanner) await scanner.stop();
        } catch (e) { /* ignore */ }
        // 스트림도 정리
        const stream = videoEl.srcObject;
        if (stream && stream.getTracks) {
          stream.getTracks().forEach(t => t.stop());
        }
        videoEl.srcObject = null;
        setRunning(false);
      }

      startBtn.addEventListener('click', startScan);
      stopBtn.addEventListener('click', stopScan);

      // 결과 제출 → 구글 시트
      document.getElementById("resultForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const result = document.getElementById("result").value;

        if (!currentSampleId) {
          alert("Sample ID가 스캔되지 않았습니다.");
          return;
        }

        try {
          const res = await fetch("https://script.google.com/macros/s/AKfycbziU3VIgI8CvAfJYzPGBvnMhoIrOFqyEeZBHve7xWUqOiJoLVA0jSBC7FDQI-mbrKiR/exec", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sampleId: currentSampleId, result })
          });
          const data = await res.json();
          if (data.status === "success") {
            statusEl.textContent = "제출 완료!";
          } else {
            statusEl.textContent = "제출 실패(응답 에러)";
          }
        } catch (err) {
          console.error(err);
          alert("제출 실패: " + err.message);
        }
      });
    });
  </script>
</body>
</html>
